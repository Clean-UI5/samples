<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>Testing special Instructions view</title>
    <script src="https://ui5.sap.com/resources/sap-ui-core.js"
      id="sap-ui-bootstrap"
      data-sap-ui-libs="sap.m,sap.ui.layout"
      data-sap-ui-theme="sap_fiori_3"
      data-sap-ui-async="true"
      data-sap-ui-compatVersion ="edge"
    ></script>
    <link rel="stylesheet" type="text/css" href="https://ui5.sap.com/resources/sap/ui/thirdparty/qunit-2.css">
    <script src="https://ui5.sap.com/resources/sap/ui/thirdparty/qunit-2.js"></script>
    <script src="https://ui5.sap.com/resources/sap/ui/qunit/qunit-junit.js"></script>
    <script src="https://ui5.sap.com/resources/sap/ui/qunit/qunit-coverage.js"></script>
    <script src="https://ui5.sap.com/resources/sap/ui/thirdparty/sinon.js"></script>
    <script src="https://ui5.sap.com/resources/sap/ui/thirdparty/sinon-qunit.js"></script>
  </head>
  <body>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
  </body>
  <script language="JavaScript">
sap.ui.require([
  'sap/ui/core/mvc/XMLView',
  'sap/ui/model/json/JSONModel'
], function (XMLView, JSONModel) {

  QUnit.module('Special instructions handling', {
    beforeEach: function (assert) {
      const done = assert.async();
      XMLView.create({
        // viewName: to load the view from the XML file
        definition: `<mvc:view
  xmlns:mvc="sap.ui.core.mvc"
  xmlns:m="sap.m"
>
  <m:Button id="finalizeReview"
    enabled="{= !(\${amount} &gt; \${si>/threshold} &amp;&amp; \${customer/vip})
                || !!\${specialInstruction}
             }"
  />
  <m:MessageStrip id="siContent"
    visible="{= \${amount} &gt; \${si>/threshold} &amp;&amp; \${customer/vip}
                &amp;&amp; !\${specialInstruction}
             }"
  />
  <m:Button id="ackSI"
    visible="{= \${amount} &gt; \${si>/threshold} &amp;&amp; \${customer/vip}
                &amp;&amp; !\${specialInstruction}
             }"
  />
  <m:MessageStrip id="siAckInfo"
    visible="{= !!\${specialInstruction} }"
  />
</mvc:view>`
      }).then((view) => {
        this.view = view;
        this.defaultModel = new JSONModel({
          amount: 0,
          customer: {
            vip: false
          },
          specialInstruction: null
        });
        view.setModel(this.defaultModel);
        view.bindElement('/');
        this.siModel = new JSONModel({
          threshold: 100
        });
        view.setModel(this.siModel, 'si');
        done();
      });
    }
  });

  function setModelsState (amount, vip, specialInstruction = null) {
    this.defaultModel.setProperty('/amount', amount);
    this.defaultModel.setProperty('/customer/vip', vip);
    this.defaultModel.setProperty('/specialInstruction', specialInstruction);
  }

  function checkUIState (assert, view, {
    specialInstructionsIsVisible,
    finalizeReviewIsEnabled,
    acknowledgeSIIsVisible,
    specialInstructionsAckInfoIsVisible
  }) {
    assert.strictEqual(view.byId('siContent').getVisible(), specialInstructionsIsVisible, 'Special instructions message strip');
    assert.strictEqual(view.byId('finalizeReview').getEnabled(), finalizeReviewIsEnabled, 'Finalize review button');
    assert.strictEqual(view.byId('ackSI').getVisible(), acknowledgeSIIsVisible, 'Acknowledge button');
    assert.strictEqual(view.byId('siAckInfo').getVisible(), specialInstructionsAckInfoIsVisible, 'Acknowledged info message strip');
  }

  QUnit.test('View and controls are loaded', function (assert) {
    assert.notStrictEqual(this.view, undefined, 'View object exists');
    const finalizeReview = this.view.byId('finalizeReview');
    assert.notStrictEqual(finalizeReview, undefined, 'Finalize review button is available');
    assert.ok(finalizeReview.isA('sap.m.Button'), 'Finalize review button is a sap.m.Button');
  });

  QUnit.test('Not a VIP customer', function (assert) {
    setModelsState.call(this, 101, false);
    checkUIState(assert, this.view, {
      specialInstructionsIsVisible: false,
      finalizeReviewIsEnabled: true,
      acknowledgeSIIsVisible: false,
      specialInstructionsAckInfoIsVisible: false
    });
  });

  QUnit.test('Not a high amount', function (assert) {
    setModelsState.call(this, 99, true);
    checkUIState(assert, this.view, {
      specialInstructionsIsVisible: false,
      finalizeReviewIsEnabled: true,
      acknowledgeSIIsVisible: false,
      specialInstructionsAckInfoIsVisible: false
    });
  });

  QUnit.test('VIP customer and high amount', function (assert) {
    setModelsState.call(this, 101, true);
    checkUIState(assert, this.view, {
      specialInstructionsIsVisible: true,
      finalizeReviewIsEnabled: false,
      acknowledgeSIIsVisible: true,
      specialInstructionsAckInfoIsVisible: false
    });
  });

  QUnit.test('VIP customer and high amount, special instructions acknowledged', function (assert) {
    setModelsState.call(this, 101, true, {});
    checkUIState(assert, this.view, {
      specialInstructionsIsVisible: false,
      finalizeReviewIsEnabled: true,
      acknowledgeSIIsVisible: false,
      specialInstructionsAckInfoIsVisible: true
    });
  });

  QUnit.test('Special instructions acknowledged', function (assert) {
    setModelsState.call(this, 99, false, {});
    checkUIState(assert, this.view, {
      specialInstructionsIsVisible: false,
      finalizeReviewIsEnabled: true,
      acknowledgeSIIsVisible: false,
      specialInstructionsAckInfoIsVisible: true
    });
  });
});
  </script>
</html>
